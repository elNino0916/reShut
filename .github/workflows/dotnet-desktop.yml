name: Build MSIXBUNDLE

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        configuration: [Release]

    env:
      App_Project_Path: reShut/reShut.csproj

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@v2

    - name: Restore
      run: dotnet restore

    - name: Decode signing certificate (PFX)
      shell: pwsh
      run: |
        $pfxBytes = [Convert]::FromBase64String("${{ secrets.Base64_Encoded_Pfx }}")
        $pfxPath  = Join-Path $env:GITHUB_WORKSPACE "GitHubActionsWorkflow.pfx"
        [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
        "PfxPath=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Build + Pack (MSIXBUNDLE)
      shell: pwsh
      run: |
        msbuild $env:App_Project_Path `
          /restore `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=x64 `
          /p:GenerateAppxPackageOnBuild=true `
          /p:AppxBundle=Always `
          /p:AppxBundlePlatforms="x86|x64" `
          /p:UapAppxPackageBuildMode=StoreUpload `
          /p:AppxPackageSigningEnabled=true `
          /p:PackageCertificateKeyFile="$env:PfxPath" `
          /p:PackageCertificatePassword="${{ secrets.Pfx_Key }}" `
          /p:PublishProfile= `
          /p:PublishTrimmed=false `
          /p:TrimMode=none `
          /p:EnableTrimAnalyzer=false `
          /p:PublishReadyToRun=false


    # Export a .cer alongside the package (similar to what VS drops next to the bundle)
    - name: Export CER from PFX
      shell: pwsh
      run: |
        $pwd = ConvertTo-SecureString "${{ secrets.Pfx_Key }}" -AsPlainText -Force
        $pfx = Import-PfxCertificate -FilePath "$env:PfxPath" -CertStoreLocation Cert:\CurrentUser\My -Password $pwd

        $cerPath = Join-Path $env:GITHUB_WORKSPACE "GitHubActionsWorkflow.cer"
        Export-Certificate -Cert $pfx -FilePath $cerPath | Out-Null

        "CerPath=$cerPath" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: msixbundle
        path: |
          **\AppPackages\**\*.msixbundle
          GitHubActionsWorkflow.cer

    - name: Cleanup PFX
      shell: pwsh
      run: Remove-Item -Force -ErrorAction SilentlyContinue "$env:PfxPath"
